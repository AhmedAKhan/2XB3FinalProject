var ay_histogram=function(e,t,n){"use strict";var r=d3.select("svg."+e);var i={brush:{bar:{width:10}},scrollbar:{height:10},axis:{x:{height:20}}};i.graph={width:parseInt((r[0][0].clientWidth||r[0][0].parentNode.clientWidth)-n.margin[0]*2),height:parseInt((r[0][0].clientHeight||r[0][0].parentNode.clientHeight)-n.margin[1]*2-i.axis.x.height)-1};var s=t.group.all();var o={events:{brush:function(){var e=o.d3.extent();var n=e.map(u.scale).map(function(e){return Math.ceil(e/i.brush.bar.width)*i.brush.bar.width});var e=n.map(u.scale.invert).map(Math.floor);if(n[0]==n[1]){t.dimension.filterAll()}else{t.dimension.filterRange(e)}o.g.call(o.d3.extent(e));w.attr("x",n[0]).attr("width",n[1]-n[0]);if(S){for(var r=0,s=S.length;r<s;r++){S[r].render(0)}}},brushend:function(){if(S){for(var e=0,t=S.length;e<t;e++){S[e].render(1)}}}},resize_path:function(e){var t=+(e=="e"),n=t?-1:1,r=i.graph.height/3;var s=t?0:1;return"M"+.5*n+","+r+"A5,5 0 0 "+s+" "+6.5*n+","+(r+6)+"V"+(2*r-6)+"A5,5 0 0 "+s+" "+.5*n+","+2*r+"Z"+"M"+2.5*n+","+(r+8)+"V"+(2*r-8)+"M"+4.5*n+","+(r+8)+"V"+(2*r-8)}};var u={extent:d3.extent(s,function(e){return e.key})};if(typeof s[0].key==="object"){if(!n.bin_width){n.bin_width=1e3*3600*24}var a=Math.round((u.extent[1].getTime()-u.extent[0].getTime())/n.bin_width);var f=new Date(u.extent[1].getTime()+n.bin_width);var l=(a+1)*i.brush.bar.width;u.scale=d3.time.scale().domain([u.extent[0],f]).rangeRound([0,l])}else{if(!n.bin_width){throw"bin_width is a required option for non-timescale histogram."}var f=u.extent[1]+n.bin_width;var l=(f-u.extent[0])/n.bin_width*i.brush.bar.width;u.scale=d3.scale.linear().domain([u.extent[0],f]).rangeRound([0,l])}if(!n.tick_width){n.tick_width=50}u.axis=d3.svg.axis().tickPadding(5).tickSize(5).ticks(Math.floor(l/n.tick_width)).scale(u.scale);if(typeof n!="undefined"&&n.x_axis_format){u.axis.tickFormat(n.x_axis_format)}var c=r.append("g").attr("class","gragh").attr("clip-path",'url("#ay-clippath-graph-'+e+'")').attr("transform","translate("+n.margin.join(",")+")");var h=c.append("g").attr("class","foreground");h.selectAll("rect").data(s).enter().append("rect").attr("width",function(e){return i.brush.bar.width-1}).attr("x",function(e){return u.scale(e.key)});var p=c.append("g").attr("class","background").attr("clip-path",'url("#ay-clippath-brush-'+e+'")');p.selectAll("rect").data(s).enter().append("rect").attr("width",function(){return i.brush.bar.width-1}).attr("x",function(e){return u.scale(e.key)});if(i.graph.width/l<1){i.graph.height-=i.scrollbar.height;var d={event:d3.behavior.drag().on("drag",function(){d.move(parseInt(y.attr("x"))+d3.event.dx)}),move:function(e){var t=l-i.graph.width;var r=i.graph.width-v;if(e<0){e=0}else if(e>r){e=r}var s=e/r*t;y.attr("x",e);c.attr("transform","translate("+(-1*s+n.margin[0])+","+n.margin[1]+")");g.attr("transform","translate("+(s-m/2)+",0)")}};var v=Math.floor(i.graph.width/l*i.graph.width);if(v<50){v=50}var m=2*n.margin[0];var g=r.append("clipPath").attr("id","ay-clippath-graph-"+e).append("rect").attr("width",i.graph.width+m).attr("height",i.graph.height+i.axis.x.height);var y=r.append("rect").attr("class","scrollbar").attr("width",v).attr("height",i.scrollbar.height).attr("transform","translate("+n.margin[0]+","+(i.graph.height+n.margin[1]+i.scrollbar.height+i.axis.x.height)+")").attr("x",0).attr("y",0).call(d.event);d.move(i.graph.width)}c.append("g").attr("class","axis x").attr("transform","translate(0,"+i.graph.height+")").call(u.axis);var b=r.append("g").attr("class","axis y").attr("transform","translate("+n.margin.join(",")+")");var w=r.append("clipPath").attr("id","ay-clippath-brush-"+e).append("rect").attr("height",i.graph.height);o.d3=d3.svg.brush().x(u.scale).on("brush",o.events.brush).on("brushend",o.events.brushend);o.g=c.append("g").attr("class","brush").call(o.d3);o.g.select("rect.background").attr("width",l);o.g.selectAll("rect").attr("height",i.graph.height);o.g.selectAll(".resize").append("path").attr("d",o.resize_path);var E=function(e){var t={max:d3.max(s,function(e){return e.value})};t.scale=d3.scale.linear().range([0,i.graph.height]).domain([0,t.max]);t.scale_invert=d3.scale.linear().range([0,i.graph.height]).domain([t.max,0]);t.axis=d3.svg.axis().tickPadding(5).tickSize(5).scale(t.scale_invert).tickFormat(d3.format("d")).orient("right");b.call(t.axis);h.selectAll("rect").data(s).attr("y",function(e){return i.graph.height-t.scale(e.value)}).attr("height",function(e){return t.scale(e.value)});p.selectAll("rect").data(s).attr("y",function(e){return i.graph.height-t.scale(e.value)}).attr("height",function(e){return t.scale(e.value)})};var S;var x=function(e){S=e};E(1);return{setRelations:x,render:E}}